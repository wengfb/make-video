{% extends "base.html" %}

{% block title %}ç³»ç»Ÿé…ç½® - ç§‘æ™®è§†é¢‘è‡ªåŠ¨åŒ–åˆ¶ä½œç³»ç»Ÿ{% endblock %}

{% block head %}
<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div x-data="configManager()" x-init="init()" class="max-w-7xl mx-auto">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">âš™ï¸ ç³»ç»Ÿé…ç½®</h1>
        <p class="text-gray-600 mt-2">ç®¡ç†ç³»ç»Ÿå„é¡¹é…ç½®å‚æ•°ï¼ŒåŒ…æ‹¬AIæœåŠ¡ã€TTSè¯­éŸ³ã€è§†é¢‘è¾“å‡ºç­‰è®¾ç½®</p>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div x-show="error" class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" x-transition>
        <strong>é”™è¯¯ï¼š</strong> <span x-text="error"></span>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div x-show="success" class="mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg" x-transition>
        <span x-text="success"></span>
    </div>

    <!-- ä¸»å¸ƒå±€ï¼šä¾§è¾¹æ  + å†…å®¹åŒº -->
    <div class="flex flex-col lg:flex-row gap-6">

        <!-- å·¦ä¾§ï¼šé…ç½®åˆ†ç±»å¯¼èˆª -->
        <div class="lg:w-1/4">
            <div class="bg-white rounded-lg shadow-md p-4 sticky top-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">ğŸ“‹ é…ç½®åˆ†ç±»</h2>

                <!-- Settingsé…ç½® -->
                <div class="mb-4">
                    <div class="text-sm font-medium text-gray-500 mb-2 uppercase tracking-wide">Settings</div>
                    <nav class="space-y-1">
                        <button @click="switchSection('settings.ai')"
                                :class="activeSection === 'settings.ai' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ¤–</span> AIé…ç½®
                        </button>
                        <button @click="switchSection('settings.tts')"
                                :class="activeSection === 'settings.tts' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ™ï¸</span> TTSé…ç½®
                        </button>
                        <button @click="switchSection('settings.ai_image')"
                                :class="activeSection === 'settings.ai_image' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ¨</span> å›¾ç‰‡ç”Ÿæˆ
                        </button>
                        <button @click="switchSection('settings.video')"
                                :class="activeSection === 'settings.video' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ¬</span> è§†é¢‘é…ç½®
                        </button>
                        <button @click="switchSection('settings.subtitle')"
                                :class="activeSection === 'settings.subtitle' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ“</span> å­—å¹•é…ç½®
                        </button>
                        <button @click="switchSection('settings.paths')"
                                :class="activeSection === 'settings.paths' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ“</span> è·¯å¾„é…ç½®
                        </button>
                        <button @click="switchSection('settings.materials')"
                                :class="activeSection === 'settings.materials' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ”Œ</span> ç´ ææº
                        </button>
                    </nav>
                </div>

                <!-- Templatesé…ç½® -->
                <div class="mb-4">
                    <div class="text-sm font-medium text-gray-500 mb-2 uppercase tracking-wide">Templates</div>
                    <nav class="space-y-1">
                        <button @click="switchSection('templates.script_templates')"
                                :class="activeSection === 'templates.script_templates' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ“œ</span> è„šæœ¬æ¨¡æ¿
                        </button>
                        <button @click="switchSection('templates.prompt_templates')"
                                :class="activeSection === 'templates.prompt_templates' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ’¬</span> æç¤ºè¯
                        </button>
                        <button @click="switchSection('templates.visual_templates')"
                                :class="activeSection === 'templates.visual_templates' ? 'bg-purple-100 text-purple-700 border-l-4 border-purple-600' : 'text-gray-700 hover:bg-gray-100'"
                                class="w-full text-left px-3 py-2 rounded-md transition flex items-center">
                            <span class="mr-2">ğŸ­</span> è§†è§‰æ¨¡æ¿
                        </button>
                    </nav>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šé…ç½®ç¼–è¾‘åŒº -->
        <div class="lg:w-3/4">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div x-show="loading" class="bg-white rounded-lg shadow-md p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">åŠ è½½é…ç½®ä¸­...</p>
            </div>

            <!-- é…ç½®ç¼–è¾‘è¡¨å• -->
            <template x-if="!loading && config.settings && config.templates">
                <div class="bg-white rounded-lg shadow-md p-6">
                <!-- AIé…ç½® -->
                <div x-show="activeSection === 'settings.ai'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ¤– AIæœåŠ¡é…ç½®</h2>
                    <div class="space-y-4">
                        <!-- Provider -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">AIæä¾›å•†</label>
                            <select x-model="config.settings.ai.provider" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="glm">æ™ºè°±AI (GLM)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">é€‰æ‹©AIæœåŠ¡æä¾›å•†</p>
                        </div>

                        <!-- Model -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹åç§°</label>
                            <input type="text" x-model="config.settings.ai.model" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="gpt-4">
                            <p class="text-xs text-gray-500 mt-1">æŒ‡å®šä½¿ç”¨çš„AIæ¨¡å‹</p>
                        </div>

                        <!-- API Key -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">APIå¯†é’¥</label>
                            <div class="flex gap-2">
                                <input type="password" x-model="config.settings.ai.api_key" class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="sk-...">
                                <button @click="testApi('ai')" :disabled="testingApi" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50 whitespace-nowrap">
                                    <span x-show="!testingApi">ğŸ§ª æµ‹è¯•</span>
                                    <span x-show="testingApi">æµ‹è¯•ä¸­...</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">APIè®¿é—®å¯†é’¥</p>
                        </div>

                        <!-- Base URL -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">APIåœ°å€</label>
                            <input type="text" x-model="config.settings.ai.base_url" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="https://api.openai.com/v1">
                            <p class="text-xs text-gray-500 mt-1">APIæœåŠ¡åœ°å€ï¼ˆå¯é€‰ï¼Œç”¨äºè‡ªå®šä¹‰endpointï¼‰</p>
                        </div>

                        <!-- Temperature -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¸©åº¦: <span x-text="config.settings.ai.temperature"></span></label>
                            <input type="range" x-model="config.settings.ai.temperature" min="0" max="2" step="0.1" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„éšæœºæ€§ï¼ˆ0-2ï¼‰</p>
                        </div>

                        <!-- Max Tokens -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§ä»¤ç‰Œæ•°</label>
                            <input type="number" x-model="config.settings.ai.max_tokens" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">å•æ¬¡è¯·æ±‚æœ€å¤§tokenæ•°é‡</p>
                        </div>
                    </div>
                </div>

                <!-- TTSé…ç½® -->
                <div x-show="activeSection === 'settings.tts'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ™ï¸ TTSè¯­éŸ³åˆæˆé…ç½®</h2>
                    <div class="space-y-4">
                        <!-- Provider -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">TTSæä¾›å•†</label>
                            <select x-model="config.settings.tts.provider" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="edge">Microsoft Edge TTS (å…è´¹)</option>
                                <option value="openai">OpenAI TTS</option>
                            </select>
                        </div>

                        <!-- Model -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹</label>
                            <input type="text" x-model="config.settings.tts.model" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- API Key -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">APIå¯†é’¥ï¼ˆOpenAI TTSéœ€è¦ï¼‰</label>
                            <input type="password" x-model="config.settings.tts.api_key" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Voice -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¯­éŸ³</label>
                            <select x-model="config.settings.tts.voice" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="zh-CN-XiaoxiaoNeural">æ™“æ™“ (å¥³å£°)</option>
                                <option value="zh-CN-YunxiNeural">äº‘å¸Œ (ç”·å£°)</option>
                                <option value="zh-CN-YunyangNeural">äº‘æ‰¬ (ç”·å£°)</option>
                                <option value="zh-CN-XiaoyiNeural">æ™“ä¼Š (å¥³å£°)</option>
                                <option value="zh-CN-YunjianNeural">äº‘å¥ (ç”·å£°)</option>
                                <option value="zh-CN-XiaoxuanNeural">æ™“è± (å¥³å£°)</option>
                                <option value="zh-CN-YunxiaNeural">äº‘å¤ (ç”·å£°)</option>
                            </select>
                        </div>

                        <!-- Speed -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¯­é€Ÿ: <span x-text="config.settings.tts.speed"></span></label>
                            <input type="range" x-model="config.settings.tts.speed" min="0.25" max="4" step="0.25" class="w-full">
                        </div>

                        <!-- BGM Mixing -->
                        <div class="flex items-center">
                            <input type="checkbox" x-model="config.settings.tts.enable_bgm_mixing" class="mr-2">
                            <label class="text-sm font-medium text-gray-700">å¯ç”¨èƒŒæ™¯éŸ³ä¹æ··éŸ³</label>
                        </div>

                        <!-- BGM Volume -->
                        <div x-show="config.settings.tts.enable_bgm_mixing">
                            <label class="block text-sm font-medium text-gray-700 mb-1">èƒŒæ™¯éŸ³ä¹éŸ³é‡: <span x-text="config.settings.tts.bgm_volume"></span></label>
                            <input type="range" x-model="config.settings.tts.bgm_volume" min="0" max="1" step="0.1" class="w-full">
                        </div>
                    </div>
                </div>

                <!-- å›¾ç‰‡ç”Ÿæˆé…ç½® -->
                <div x-show="activeSection === 'settings.ai_image'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ¨ AIå›¾ç‰‡ç”Ÿæˆé…ç½®</h2>
                    <div class="space-y-4">
                        <!-- Provider -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æä¾›å•†</label>
                            <select x-model="config.settings.ai_image.provider" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="dalle">DALL-E 3 (OpenAI)</option>
                                <option value="cogview">CogView (æ™ºè°±AI)</option>
                                <option value="sd">Stable Diffusion</option>
                            </select>
                        </div>

                        <!-- Model -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹</label>
                            <input type="text" x-model="config.settings.ai_image.model" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- API Key -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">APIå¯†é’¥</label>
                            <input type="password" x-model="config.settings.ai_image.api_key" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Default Size -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é»˜è®¤å°ºå¯¸</label>
                            <select x-model="config.settings.ai_image.default_size" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="1024x1024">1024x1024 (æ­£æ–¹å½¢)</option>
                                <option value="1792x1024">1792x1024 (æ¨ªå‘)</option>
                                <option value="1024x1792">1024x1792 (çºµå‘)</option>
                            </select>
                        </div>

                        <!-- Default Quality -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é»˜è®¤è´¨é‡</label>
                            <select x-model="config.settings.ai_image.default_quality" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="standard">æ ‡å‡†</option>
                                <option value="hd">é«˜æ¸…</option>
                            </select>
                        </div>

                        <!-- Default Style -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é»˜è®¤é£æ ¼</label>
                            <textarea x-model="config.settings.ai_image.default_style" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                        </div>
                    </div>
                </div>

                <!-- è§†é¢‘é…ç½® -->
                <div x-show="activeSection === 'settings.video'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ¬ è§†é¢‘è¾“å‡ºé…ç½®</h2>
                    <div class="space-y-4">
                        <!-- Resolution -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å®½åº¦</label>
                                <input type="number" x-model="config.settings.video.resolution.width" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">é«˜åº¦</label>
                                <input type="number" x-model="config.settings.video.resolution.height" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- FPS -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸§ç‡ (FPS)</label>
                            <input type="number" x-model="config.settings.video.fps" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Output Format -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å‡ºæ ¼å¼</label>
                            <select x-model="config.settings.video.output_format" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="mp4">MP4</option>
                                <option value="avi">AVI</option>
                                <option value="mov">MOV</option>
                            </select>
                        </div>

                        <!-- Codec -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¼–ç å™¨</label>
                            <select x-model="config.settings.video.codec" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="libx264">H.264 (libx264)</option>
                                <option value="libx265">H.265 (libx265)</option>
                                <option value="mpeg4">MPEG-4</option>
                            </select>
                        </div>

                        <!-- Bitrate -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¯”ç‰¹ç‡</label>
                            <input type="text" x-model="config.settings.video.bitrate" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="3000k">
                        </div>
                    </div>
                </div>

                <!-- å­—å¹•é…ç½® -->
                <div x-show="activeSection === 'settings.subtitle'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“ å­—å¹•é…ç½®</h2>
                    <div class="space-y-4">
                        <!-- Font -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å­—ä½“</label>
                            <input type="text" x-model="config.settings.subtitle.font" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Font Size -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å­—å·</label>
                            <input type="number" x-model="config.settings.subtitle.font_size" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Font Color -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å­—ä½“é¢œè‰²</label>
                            <input type="text" x-model="config.settings.subtitle.font_color" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="white">
                        </div>

                        <!-- Position -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä½ç½®</label>
                            <select x-model="config.settings.subtitle.position" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="top">é¡¶éƒ¨</option>
                                <option value="middle">å±…ä¸­</option>
                                <option value="bottom">åº•éƒ¨</option>
                            </select>
                        </div>

                        <!-- BG Opacity -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">èƒŒæ™¯é€æ˜åº¦: <span x-text="config.settings.subtitle.bg_opacity"></span></label>
                            <input type="range" x-model="config.settings.subtitle.bg_opacity" min="0" max="1" step="0.1" class="w-full">
                        </div>
                    </div>
                </div>

                <!-- è·¯å¾„é…ç½® -->
                <div x-show="activeSection === 'settings.paths'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“ è·¯å¾„é…ç½®</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç´ æç›®å½•</label>
                            <input type="text" x-model="config.settings.paths.materials" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿ç›®å½•</label>
                            <input type="text" x-model="config.settings.paths.templates" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å‡ºç›®å½•</label>
                            <input type="text" x-model="config.settings.paths.output" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è„šæœ¬ç›®å½•</label>
                            <input type="text" x-model="config.settings.paths.scripts" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å­—å¹•ç›®å½•</label>
                            <input type="text" x-model="config.settings.paths.subtitles" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è§†é¢‘ç›®å½•</label>
                            <input type="text" x-model="config.settings.paths.videos" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">éŸ³é¢‘ç›®å½•</label>
                            <input type="text" x-model="config.settings.paths.audio" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- ç´ ææºé…ç½® -->
                <div x-show="activeSection === 'settings.materials'">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ”Œ ç´ ææºé…ç½®</h2>

                    <!-- Pexels -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">Pexels</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">APIå¯†é’¥</label>
                                <input type="password" x-model="config.settings.pexels.api_key" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">å…è´¹ç”³è¯·: https://www.pexels.com/api/</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¯å°æ—¶è¯·æ±‚é™åˆ¶</label>
                                <input type="number" x-model="config.settings.pexels.rate_limit_per_hour" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Unsplash -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Unsplash</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Access Key</label>
                                <input type="password" x-model="config.settings.unsplash.access_key" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">å…è´¹æ³¨å†Œ: https://unsplash.com/developers</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¯å°æ—¶è¯·æ±‚é™åˆ¶</label>
                                <input type="number" x-model="config.settings.unsplash.rate_limit_per_hour" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Templatesé…ç½® -->
                <div x-show="activeSection.startsWith('templates.')">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800" x-text="getSectionTitle()"></h2>

                    <!-- è„šæœ¬æ¨¡æ¿ç¼–è¾‘ -->
                    <div x-show="activeSection === 'templates.script_templates'" class="space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-gray-600">ç®¡ç†è„šæœ¬ç”Ÿæˆæ¨¡æ¿ï¼Œå®šä¹‰è§†é¢‘çš„ç»“æ„å’Œç« èŠ‚</p>
                            <button @click="addScriptTemplate()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                â• æ·»åŠ æ–°æ¨¡æ¿
                            </button>
                        </div>

                        <template x-for="(template, templateKey) in config.templates.script_templates" :key="templateKey">
                            <div class="border border-gray-200 rounded-lg p-6 bg-white">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1 grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿ID</label>
                                            <input type="text" x-model="templateKey" readonly
                                                   class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50 text-gray-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿åç§°</label>
                                            <input type="text" x-model="template.name" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500">
                                        </div>
                                    </div>
                                    <button @click="deleteScriptTemplate(templateKey)" class="text-red-600 hover:text-red-800 text-sm ml-4">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ¿æè¿°</label>
                                    <textarea x-model="template.description" rows="2"
                                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500"></textarea>
                                </div>

                                <div class="space-y-4">
                                    <h4 class="font-semibold text-gray-800">ç« èŠ‚ç»“æ„</h4>
                                    <template x-for="(section, index) in template.structure" :key="index">
                                        <div class="border border-gray-200 rounded-md p-4 bg-gray-50">
                                            <div class="flex justify-between items-center mb-3">
                                                <h5 class="font-medium text-gray-700" x-text="'ç« èŠ‚ ' + (index + 1) + ': ' + section.name"></h5>
                                                <button @click="template.structure.splice(index, 1)" class="text-red-600 hover:text-red-800 text-sm">
                                                    åˆ é™¤ç« èŠ‚
                                                </button>
                                            </div>

                                            <div class="grid grid-cols-3 gap-4 mb-3">
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">ç« èŠ‚ID</label>
                                                    <input type="text" x-model="section.section" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">ç« èŠ‚åç§°</label>
                                                    <input type="text" x-model="section.name" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">å»ºè®®æ—¶é•¿</label>
                                                    <input type="text" x-model="section.duration" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm" placeholder="å¦‚: 30-45ç§’">
                                                </div>
                                            </div>

                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">ç« èŠ‚æç¤ºè¯</label>
                                                <textarea x-model="section.prompt" rows="3"
                                                          class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-purple-500"></textarea>
                                            </div>
                                        </div>
                                    </template>

                                    <button @click="addSectionToTemplate(templateKey)" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-purple-500 hover:text-purple-600">
                                        â• æ·»åŠ æ–°ç« èŠ‚
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- æç¤ºè¯æ¨¡æ¿ç¼–è¾‘ -->
                    <div x-show="activeSection === 'templates.prompt_templates'" class="space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-gray-600">ç®¡ç†AIæç¤ºè¯æ¨¡æ¿ï¼Œæ§åˆ¶AIç”Ÿæˆè¡Œä¸º</p>
                            <button @click="addPromptTemplate()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                â• æ·»åŠ æ–°æç¤ºè¯
                            </button>
                        </div>

                        <template x-for="(prompt, promptKey) in config.templates.prompt_templates" :key="promptKey">
                            <div class="border border-gray-200 rounded-lg p-6 bg-white">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">æç¤ºè¯åç§°</label>
                                        <input type="text" x-model="promptKey" readonly
                                               class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50 text-gray-500 font-mono text-sm">
                                    </div>
                                    <button @click="deletePromptTemplate(promptKey)" class="text-red-600 hover:text-red-800 text-sm ml-4">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æç¤ºè¯å†…å®¹</label>
                                    <p class="text-xs text-gray-500 mb-2">å¯ä»¥ä½¿ç”¨å˜é‡å¦‚ {topic}, {audience}, {duration} ç­‰</p>
                                    <textarea x-model="config.templates.prompt_templates[promptKey]" rows="10"
                                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 font-mono text-sm"></textarea>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- è§†è§‰æ¨¡æ¿ç¼–è¾‘ -->
                    <div x-show="activeSection === 'templates.visual_templates'" class="space-y-6">
                        <p class="text-gray-600 mb-4">é…ç½®ç‰‡å¤´ã€ç‰‡å°¾å’Œè½¬åœºæ•ˆæœ</p>

                        <!-- Intro -->
                        <div class="border border-gray-200 rounded-lg p-6 bg-white">
                            <h4 class="font-semibold text-gray-800 mb-4">ğŸ¬ ç‰‡å¤´</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ—¶é•¿ï¼ˆç§’ï¼‰</label>
                                    <input type="number" step="0.5" x-model="config.templates.visual_templates.intro.duration"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">åŒ…å«å…ƒç´ ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                                <template x-for="(element, index) in config.templates.visual_templates.intro.elements" :key="index">
                                    <div class="flex gap-2 mb-2">
                                        <input type="text" x-model="config.templates.visual_templates.intro.elements[index]"
                                               class="flex-1 border border-gray-300 rounded-md px-3 py-2">
                                        <button @click="config.templates.visual_templates.intro.elements.splice(index, 1)"
                                                class="text-red-600 hover:text-red-800">âœ•</button>
                                    </div>
                                </template>
                                <button @click="config.templates.visual_templates.intro.elements.push('')"
                                        class="mt-2 text-sm text-purple-600 hover:text-purple-800">
                                    â• æ·»åŠ å…ƒç´ 
                                </button>
                            </div>
                        </div>

                        <!-- Outro -->
                        <div class="border border-gray-200 rounded-lg p-6 bg-white">
                            <h4 class="font-semibold text-gray-800 mb-4">ğŸ­ ç‰‡å°¾</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ—¶é•¿ï¼ˆç§’ï¼‰</label>
                                    <input type="number" step="0.5" x-model="config.templates.visual_templates.outro.duration"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">åŒ…å«å…ƒç´ ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                                <template x-for="(element, index) in config.templates.visual_templates.outro.elements" :key="index">
                                    <div class="flex gap-2 mb-2">
                                        <input type="text" x-model="config.templates.visual_templates.outro.elements[index]"
                                               class="flex-1 border border-gray-300 rounded-md px-3 py-2">
                                        <button @click="config.templates.visual_templates.outro.elements.splice(index, 1)"
                                                class="text-red-600 hover:text-red-800">âœ•</button>
                                    </div>
                                </template>
                                <button @click="config.templates.visual_templates.outro.elements.push('')"
                                        class="mt-2 text-sm text-purple-600 hover:text-purple-800">
                                    â• æ·»åŠ å…ƒç´ 
                                </button>
                            </div>
                        </div>

                        <!-- Transition -->
                        <div class="border border-gray-200 rounded-lg p-6 bg-white">
                            <h4 class="font-semibold text-gray-800 mb-4">ğŸ”„ è½¬åœºæ•ˆæœ</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é»˜è®¤æ—¶é•¿ï¼ˆç§’ï¼‰</label>
                                    <input type="number" step="0.1" x-model="config.templates.visual_templates.transition.duration"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å¯ç”¨è½¬åœºç±»å‹ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                                    <input type="text" x-model="transitionTypesString"
                                           @input="updateTransitionTypes($event.target.value)"
                                           class="w-full border border-gray-300 rounded-md px-3 py-2"
                                           placeholder="æ·¡å…¥æ·¡å‡º, å·¦å³æ»‘åŠ¨, ç¼©æ”¾">
                                </div>
                            </div>

                            <div class="mt-4">
                                <p class="text-sm text-gray-600 mb-2">å½“å‰è½¬åœºç±»å‹ï¼š</p>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="(type, index) in config.templates.visual_templates.transition.types" :key="index">
                                        <span class="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">
                                            <span x-text="type"></span>
                                            <button @click="config.templates.visual_templates.transition.types.splice(index, 1)"
                                                    class="text-purple-600 hover:text-purple-800 ml-1">âœ•</button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æˆåŠŸ/é”™è¯¯æç¤º -->
                <div x-show="error" class="mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" x-transition>
                    <strong>é”™è¯¯ï¼š</strong> <span x-text="error"></span>
                </div>

                <div x-show="success" class="mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg" x-transition>
                    <span x-text="success"></span>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="mt-8 flex gap-4 border-t pt-6">
                    <button @click="saveConfig()" :disabled="saving" class="flex-1 bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 disabled:opacity-50 font-medium">
                        <span x-show="!saving">ğŸ’¾ ä¿å­˜é…ç½®</span>
                        <span x-show="saving">ä¿å­˜ä¸­...</span>
                    </button>
                    <button @click="loadConfig()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function configManager() {
    return {
        // çŠ¶æ€
        activeSection: 'settings.ai',
        config: {
            settings: {
                ai: {},
                tts: {},
                ai_image: {},
                video: { resolution: {}, codec: '', output_format: '', bitrate: '', fps: 24 },
                subtitle: {},
                paths: {},
                pexels: {},
                unsplash: {}
            },
            templates: {
                script_templates: {},
                prompt_templates: {},
                visual_templates: {
                    intro: { duration: 3, elements: [] },
                    outro: { duration: 5, elements: [] },
                    transition: { duration: 0.5, types: [] }
                }
            }
        },
        originalConfig: {},
        loading: false,
        saving: false,
        testingApi: false,
        error: '',
        success: '',

        // åˆå§‹åŒ–
        async init() {
            await this.loadConfig();
            this.updateTransitionTypesString();
        },

        // åŠ è½½é…ç½®
        async loadConfig() {
            this.loading = true;
            this.error = '';
            this.success = '';

            try {
                const response = await fetch('/api/config/');
                const data = await response.json();

                if (data.success) {
                    this.config = data.data;
                    this.originalConfig = JSON.parse(JSON.stringify(data.data));
                } else {
                    this.error = 'åŠ è½½é…ç½®å¤±è´¥: ' + data.message;
                }
            } catch (e) {
                this.error = 'åŠ è½½é…ç½®å¤±è´¥: ' + e.message;
            } finally {
                this.loading = false;
            }
        },

        // ä¿å­˜é…ç½®
        async saveConfig() {
            this.saving = true;
            this.error = '';
            this.success = '';

            try {
                // è§£æå½“å‰æ¿€æ´»çš„é…ç½®åŒºå—
                const [configType, section] = this.activeSection.split('.');

                if (configType === 'settings') {
                    // è·å–åŸå§‹é…ç½®ä¸­çš„åŒºå—è·¯å¾„
                    const sectionPath = section.split('_').slice(1).join('_'); // ç§»é™¤'ai'å‰ç¼€
                    const updates = this.extractUpdates(section);

                    const response = await fetch('/api/config/settings', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            section: section,
                            updates: updates,
                            create_backup: true
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.success = data.message;
                        this.originalConfig = JSON.parse(JSON.stringify(this.config));
                    } else {
                        this.error = data.message || 'ä¿å­˜å¤±è´¥';
                    }
                } else if (configType === 'templates') {
                    // ä¿å­˜templatesé…ç½®
                    const updates = this.extractTemplateUpdates(section);

                    const response = await fetch('/api/config/templates', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            section: section,
                            updates: updates,
                            create_backup: true
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.success = data.message;
                        this.originalConfig = JSON.parse(JSON.stringify(this.config));
                    } else {
                        this.error = data.message || 'ä¿å­˜å¤±è´¥';
                    }
                }
            } catch (e) {
                this.error = 'ä¿å­˜é…ç½®å¤±è´¥: ' + e.message;
            } finally {
                this.saving = false;

                // 3ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯
                if (this.success) {
                    setTimeout(() => {
                        this.success = '';
                    }, 3000);
                }
            }
        },

        // æå–è¦æ›´æ–°çš„å­—æ®µ
        extractUpdates(section) {
            const updates = {};

            if (section === 'ai') {
                Object.assign(updates, this.config.settings.ai);
            } else if (section === 'tts') {
                Object.assign(updates, this.config.settings.tts);
            } else if (section === 'ai_image') {
                Object.assign(updates, this.config.settings.ai_image);
            } else if (section === 'video') {
                Object.assign(updates, this.config.settings.video);
            } else if (section === 'subtitle') {
                Object.assign(updates, this.config.settings.subtitle);
            } else if (section === 'paths') {
                Object.assign(updates, this.config.settings.paths);
            } else if (section === 'materials') {
                updates.pexels = this.config.settings.pexels;
                updates.unsplash = this.config.settings.unsplash;
            }

            return updates;
        },

        // åˆ‡æ¢é…ç½®åŒºå—
        switchSection(section) {
            this.activeSection = section;
            this.error = '';
            this.success = '';
        },

        // æµ‹è¯•API
        async testApi(section) {
            this.testingApi = true;
            this.error = '';
            this.success = '';

            try {
                let request;

                if (section === 'ai') {
                    request = {
                        provider: this.config.settings.ai.provider,
                        api_key: this.config.settings.ai.api_key,
                        base_url: this.config.settings.ai.base_url,
                        model: this.config.settings.ai.model
                    };
                }

                const response = await fetch('/api/config/test-api', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(request)
                });

                const data = await response.json();

                if (data.success) {
                    this.success = 'âœ… ' + data.message;
                } else {
                    this.error = 'âŒ ' + data.message;
                }
            } catch (e) {
                this.error = 'æµ‹è¯•å¤±è´¥: ' + e.message;
            } finally {
                this.testingApi = false;

                // 5ç§’åæ¸…é™¤æ¶ˆæ¯
                setTimeout(() => {
                    if (this.success.startsWith('âœ…')) {
                        this.success = '';
                    }
                }, 5000);
            }
        },

        // è·å–å½“å‰æ¨¡æ¿é…ç½®
        getCurrentTemplateConfig() {
            const [, sectionType] = this.activeSection.split('.');
            return this.config.templates[sectionType] || {};
        },

        // è·å–åŒºå—æ ‡é¢˜
        getSectionTitle() {
            const titles = {
                'templates.script_templates': 'ğŸ“œ è„šæœ¬æ¨¡æ¿',
                'templates.prompt_templates': 'ğŸ’¬ æç¤ºè¯æ¨¡æ¿',
                'templates.visual_templates': 'ğŸ­ è§†è§‰æ¨¡æ¿'
            };
            return titles[this.activeSection] || 'æ¨¡æ¿é…ç½®';
        },

        // æå–templatesæ›´æ–°
        extractTemplateUpdates(section) {
            return this.config.templates[section];
        },

        // æ·»åŠ è„šæœ¬æ¨¡æ¿
        addScriptTemplate() {
            const newId = prompt('è¯·è¾“å…¥æ–°æ¨¡æ¿çš„IDï¼ˆè‹±æ–‡ï¼Œå¦‚ï¼šmy_templateï¼‰');
            if (!newId) return;

            if (this.config.templates.script_templates[newId]) {
                alert('æ¨¡æ¿IDå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ID');
                return;
            }

            this.config.templates.script_templates[newId] = {
                name: 'æ–°æ¨¡æ¿',
                description: 'æ¨¡æ¿æè¿°',
                structure: [
                    {
                        section: 'intro',
                        name: 'å¼€åœº',
                        duration: '10-15ç§’',
                        prompt: 'å¼€åœºç™½å†…å®¹...'
                    }
                ]
            };
        },

        // åˆ é™¤è„šæœ¬æ¨¡æ¿
        deleteScriptTemplate(templateKey) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿"${templateKey}"å—ï¼Ÿ`)) {
                delete this.config.templates.script_templates[templateKey];
            }
        },

        // æ·»åŠ ç« èŠ‚åˆ°æ¨¡æ¿
        addSectionToTemplate(templateKey) {
            const template = this.config.templates.script_templates[templateKey];
            if (template && template.structure) {
                template.structure.push({
                    section: 'new_section',
                    name: 'æ–°ç« èŠ‚',
                    duration: '30ç§’',
                    prompt: 'ç« èŠ‚å†…å®¹...'
                });
            }
        },

        // æ·»åŠ æç¤ºè¯æ¨¡æ¿
        addPromptTemplate() {
            const newId = prompt('è¯·è¾“å…¥æ–°æç¤ºè¯çš„IDï¼ˆè‹±æ–‡ï¼Œå¦‚ï¼šmy_promptï¼‰');
            if (!newId) return;

            if (this.config.templates.prompt_templates[newId]) {
                alert('æç¤ºè¯IDå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ID');
                return;
            }

            this.config.templates.prompt_templates[newId] = 'è¯·è¾“å…¥æç¤ºè¯å†…å®¹...';
        },

        // åˆ é™¤æç¤ºè¯æ¨¡æ¿
        deletePromptTemplate(promptKey) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æç¤ºè¯"${promptKey}"å—ï¼Ÿ`)) {
                delete this.config.templates.prompt_templates[promptKey];
            }
        },

        // è½¬åœºç±»å‹å­—ç¬¦ä¸²ï¼ˆåœ¨initä¸­åˆå§‹åŒ–ï¼‰
        transitionTypesString: '',

        // æ›´æ–°è½¬åœºç±»å‹
        updateTransitionTypes(value) {
            if (!this.config.templates.visual_templates) return;
            if (!this.config.templates.visual_templates.transition) return;

            const types = value.split(',').map(t => t.trim()).filter(t => t);
            this.config.templates.visual_templates.transition.types = types;
        },

        // æ›´æ–°è½¬åœºç±»å‹å­—ç¬¦ä¸²
        updateTransitionTypesString() {
            if (this.config.templates.visual_templates &&
                this.config.templates.visual_templates.transition &&
                this.config.templates.visual_templates.transition.types) {
                this.transitionTypesString = this.config.templates.visual_templates.transition.types.join(', ');
            }
        }
    };
}
</script>
{% endblock %}
