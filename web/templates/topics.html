{% extends "base.html" %}

{% block title %}ä¸»é¢˜ç”Ÿæˆ - ç§‘æ™®è§†é¢‘è‡ªåŠ¨åŒ–åˆ¶ä½œç³»ç»Ÿ{% endblock %}

{% block content %}
<div x-data="topicGenerator()" x-init="init()">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“ ç”Ÿæˆè§†é¢‘ä¸»é¢˜</h1>
        <p class="text-gray-600">ä½¿ç”¨AIç”Ÿæˆç§‘æ™®è§†é¢‘ä¸»é¢˜å»ºè®®</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- å·¦ä¾§ï¼šç”Ÿæˆè¡¨å• -->
        <div class="lg:col-span-1">
            <div class="card">
                <h2 class="text-xl font-bold mb-6">ç”Ÿæˆå‚æ•°</h2>

                <form @submit.prevent="generateTopics">
                    <!-- ç§‘å­¦é¢†åŸŸ -->
                    <div class="form-group">
                        <label class="form-label">ç§‘å­¦é¢†åŸŸ</label>
                        <select x-model="form.field" class="form-select">
                            <option value="">ä¸é™é¢†åŸŸ</option>
                            <option value="physics">ç‰©ç†å­¦</option>
                            <option value="chemistry">åŒ–å­¦</option>
                            <option value="biology">ç”Ÿç‰©å­¦</option>
                            <option value="astronomy">å¤©æ–‡å­¦</option>
                            <option value="geology">åœ°è´¨å­¦</option>
                            <option value="ecology">ç”Ÿæ€å­¦</option>
                            <option value="technology">ç§‘æŠ€</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ç•™ç©ºåˆ™éšæœºé€‰æ‹©é¢†åŸŸ</p>
                    </div>

                    <!-- ç›®æ ‡å—ä¼— -->
                    <div class="form-group">
                        <label class="form-label">ç›®æ ‡å—ä¼—</label>
                        <select x-model="form.audience" class="form-select">
                            <option value="general_public">å¤§ä¼—</option>
                            <option value="students">å­¦ç”Ÿ</option>
                            <option value="children">å„¿ç«¥</option>
                            <option value="experts">ä¸“å®¶</option>
                        </select>
                    </div>

                    <!-- ç”Ÿæˆæ•°é‡ -->
                    <div class="form-group">
                        <label class="form-label">
                            ç”Ÿæˆæ•°é‡: <span x-text="form.count"></span>
                        </label>
                        <input
                            type="range"
                            x-model="form.count"
                            min="1"
                            max="20"
                            class="w-full"
                        >
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>1</span>
                            <span>20</span>
                        </div>
                    </div>

                    <!-- é£æ ¼ -->
                    <div class="form-group">
                        <label class="form-label">é£æ ¼</label>
                        <select x-model="form.style" class="form-select">
                            <option value="educational">æ•™è‚²æ€§</option>
                            <option value="entertaining">å¨±ä¹æ€§</option>
                            <option value="inspiring">å¯å‘æ€§</option>
                            <option value="practical">å®ç”¨æ€§</option>
                        </select>
                    </div>

                    <!-- è‡ªå®šä¹‰è¦æ±‚ -->
                    <div class="form-group">
                        <label class="form-label">è‡ªå®šä¹‰è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea
                            x-model="form.custom_requirements"
                            class="form-input"
                            rows="3"
                            placeholder="ä¾‹å¦‚ï¼šå…³æ³¨ç¯ä¿ä¸»é¢˜ï¼Œé¢å‘é’å°‘å¹´..."
                        ></textarea>
                    </div>

                    <!-- æˆæœ¬é¢„ä¼° -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-blue-800">é¢„ä¼°APIæˆæœ¬:</span>
                            <span class="text-lg font-bold text-blue-900" x-text="estimatedCost"></span>
                        </div>
                    </div>

                    <!-- ç”ŸæˆæŒ‰é’® -->
                    <button
                        type="submit"
                        :disabled="loading"
                        class="btn btn-primary w-full"
                    >
                        <template x-if="!loading">
                            <span>ğŸš€ ç”Ÿæˆä¸»é¢˜</span>
                        </template>
                        <template x-if="loading">
                            <span class="flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                ç”Ÿæˆä¸­...
                            </span>
                        </template>
                    </button>
                </form>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè¿›åº¦å’Œç»“æœ -->
        <div class="lg:col-span-2">
            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div x-show="loading" class="card mb-6">
                <h3 class="text-lg font-bold mb-4">ç”Ÿæˆè¿›åº¦</h3>

                <!-- è¿›åº¦æ¡ -->
                <div class="progress-bar-container mb-4">
                    <div
                        class="progress-bar progress-bar-animated"
                        :style="`width: ${progress}%`"
                    ></div>
                </div>

                <!-- è¿›åº¦ä¿¡æ¯ -->
                <div class="flex justify-between text-sm">
                    <span x-text="progressMessage"></span>
                    <span class="font-semibold" x-text="`${progress}%`"></span>
                </div>

                <!-- é¢„è®¡æ—¶é—´ -->
                <div x-show="progress > 0 && progress < 100" class="mt-4 text-sm text-gray-600">
                    <p>â±ï¸ é¢„è®¡å‰©ä½™æ—¶é—´: <span x-text="estimatedTime"></span></p>
                </div>
            </div>

            <!-- é”™è¯¯æç¤º -->
            <div x-show="error" class="alert alert-error mb-6">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">âŒ</span>
                    <div>
                        <p class="font-bold">ç”Ÿæˆå¤±è´¥</p>
                        <p class="text-sm" x-text="error"></p>
                    </div>
                </div>
            </div>

            <!-- ç”Ÿæˆç»“æœ -->
            <div x-show="topics.length > 0">
                <!-- ç»“æœç»Ÿè®¡ -->
                <div class="card mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold">ç”Ÿæˆç»“æœ</h3>
                            <p class="text-sm text-gray-600">
                                å…±ç”Ÿæˆ <span class="font-semibold text-purple-600" x-text="topics.length"></span> ä¸ªä¸»é¢˜
                            </p>
                        </div>
                        <button
                            @click="regenerateAll"
                            class="btn btn-secondary text-sm"
                        >
                            ğŸ”„ é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                </div>

                <!-- ä¸»é¢˜å¡ç‰‡åˆ—è¡¨ -->
                <div class="topics-grid">
                    <template x-for="(topic, index) in topics" :key="topic.id">
                        <div class="topic-card">
                            <!-- åºå· -->
                            <div class="flex items-center justify-between mb-3">
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-semibold">
                                    #<span x-text="index + 1"></span>
                                </span>
                                <span class="text-xs text-gray-500" x-text="topic?.difficulty || 'æœªçŸ¥'"></span>
                            </div>

                            <!-- æ ‡é¢˜ -->
                            <h4 class="text-lg font-bold mb-2" x-text="topic?.title || 'æœªå‘½åä¸»é¢˜'"></h4>

                            <!-- æè¿° -->
                            <p class="text-gray-600 text-sm mb-4 line-clamp-3" x-text="topic?.description || 'æš‚æ— æè¿°'"></p>

                            <!-- æ ‡ç­¾ -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="tag tag-blue text-xs" x-text="topic?.field || 'æœªçŸ¥'"></span>
                                <span class="tag tag-green text-xs" x-text="topic?.target_audience || 'æœªçŸ¥'"></span>
                            </div>

                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex gap-2">
                                <button
                                    @click="useTopic(topic)"
                                    class="btn btn-primary flex-1 text-sm"
                                >
                                    ä½¿ç”¨æ­¤ä¸»é¢˜
                                </button>
                                <button
                                    @click="copyTopic(topic)"
                                    class="btn btn-secondary text-sm"
                                    title="å¤åˆ¶"
                                >
                                    ğŸ“‹
                                </button>
                                <button
                                    @click="saveTopic(topic)"
                                    class="btn btn-success text-sm"
                                    :class="{'opacity-50': topic.saved}"
                                    :disabled="topic.saved"
                                    title="ä¿å­˜"
                                >
                                    <span x-show="!topic.saved">â­</span>
                                    <span x-show="topic.saved">âœ…</span>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div x-show="!loading && !error && topics.length === 0" class="text-center py-16">
                <div class="text-6xl mb-4">ğŸ“</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">å‡†å¤‡ç”Ÿæˆä¸»é¢˜</h3>
                <p class="text-gray-600">é€‰æ‹©å·¦ä¾§å‚æ•°ï¼Œç‚¹å‡»"ç”Ÿæˆä¸»é¢˜"å¼€å§‹</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function topicGenerator() {
    return {
        form: {
            field: '',
            audience: 'general_public',
            difficulty: 'medium',
            count: 10,
            style: 'educational',
            custom_requirements: ''
        },
        loading: false,
        progress: 0,
        progressMessage: '',
        startTime: null,
        topics: [],
        error: '',

        get estimatedCost() {
            // å‡è®¾æ¯ä¸ªä¸»é¢˜æˆæœ¬ $0.002
            return `$${(this.form.count * 0.002).toFixed(4)}`;
        },

        get estimatedTime() {
            if (!this.startTime || this.progress === 0) return 'è®¡ç®—ä¸­...';

            const elapsed = Date.now() - this.startTime;
            const remaining = (elapsed / this.progress) * (100 - this.progress);

            const seconds = Math.floor(remaining / 1000);
            if (seconds < 60) return `${seconds}ç§’`;

            const minutes = Math.floor(seconds / 60);
            return `${minutes}åˆ†${seconds % 60}ç§’`;
        },

        async init() {
            console.log('ä¸»é¢˜ç”Ÿæˆé¡µé¢å·²åŠ è½½');
        },

        async generateTopics() {
            this.loading = true;
            this.progress = 0;
            this.progressMessage = 'åˆ›å»ºç”Ÿæˆä»»åŠ¡...';
            this.topics = [];
            this.error = '';
            this.startTime = Date.now();

            try {
                // åˆ›å»ºç”Ÿæˆä»»åŠ¡
                const response = await fetch('/api/topics/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.form)
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                const taskId = data.task_id;

                // è¿æ¥WebSocketç›‘å¬è¿›åº¦
                await this.watchProgress(taskId);

            } catch (error) {
                console.error('ç”Ÿæˆä¸»é¢˜å¤±è´¥:', error);
                this.error = error.message;
                this.loading = false;
            }
        },

        async watchProgress(taskId) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`ws://${window.location.host}/ws/progress/${taskId}`);

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    // æ›´æ–°è¿›åº¦
                    this.progress = data.progress || 0;
                    this.progressMessage = data.message || '';

                    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                    if (data.status === 'completed') {
                        this.topics = data.result.topics || [];
                        this.loading = false;
                        ws.close();
                        resolve();

                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        window.appUtils?.showToast(
                            `æˆåŠŸç”Ÿæˆ ${this.topics.length} ä¸ªä¸»é¢˜`,
                            'success'
                        );

                    } else if (data.status === 'failed') {
                        this.error = data.error || 'ç”Ÿæˆå¤±è´¥';
                        this.loading = false;
                        ws.close();
                        reject(new Error(data.error));

                        window.appUtils?.showToast(this.error, 'error');
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    this.error = 'WebSocketè¿æ¥å¤±è´¥';
                    this.loading = false;
                    ws.close();
                    reject(error);
                };
            });
        },

        regenerateAll() {
            this.generateTopics();
        },

        useTopic(topic) {
            // è·³è½¬åˆ°è„šæœ¬ç”Ÿæˆé¡µé¢ï¼Œå¹¶ä¼ é€’ä¸»é¢˜
            // TODO: å®ç°è·¨é¡µé¢æ•°æ®ä¼ é€’
            window.appUtils?.showToast('å³å°†è·³è½¬åˆ°è„šæœ¬ç”Ÿæˆé¡µé¢...', 'info');
            setTimeout(() => {
                window.location.href = `/scripts?topic_id=${topic.id}`;
            }, 1000);
        },

        copyTopic(topic) {
            const text = `${topic.title}\n\n${topic.description}\n\né¢†åŸŸ: ${topic.field}\néš¾åº¦: ${topic.difficulty}`;

            navigator.clipboard.writeText(text).then(() => {
                window.appUtils?.showToast('ä¸»é¢˜å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                window.appUtils?.showToast('å¤åˆ¶å¤±è´¥', 'error');
            });
        },

        async saveTopic(topic) {
            try {
                const response = await fetch('/api/topics/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(topic)
                });

                const data = await response.json();

                if (data.success) {
                    topic.saved = true;
                    topic.saved_id = data.topic_id;
                    window.appUtils?.showToast('ä¸»é¢˜å·²ä¿å­˜', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜ä¸»é¢˜å¤±è´¥:', error);
                window.appUtils?.showToast(error.message, 'error');
            }
        }
    };
}
</script>
{% endblock %}
