{% extends "base.html" %}

{% block title %}è„šæœ¬ç”Ÿæˆ - ç§‘æ™®è§†é¢‘è‡ªåŠ¨åŒ–åˆ¶ä½œç³»ç»Ÿ{% endblock %}

{% block content %}
<div x-data="scriptGenerator()" x-init="init()">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“œ ç”Ÿæˆè§†é¢‘è„šæœ¬</h1>
        <p class="text-gray-600">ä»ä¸»é¢˜è‡ªåŠ¨ç”Ÿæˆä¸“ä¸šçš„è§†é¢‘è„šæœ¬</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- å·¦ä¾§ï¼šç”Ÿæˆè¡¨å• -->
        <div class="lg:col-span-1">
            <div class="card">
                <h2 class="text-xl font-bold mb-6">ç”Ÿæˆå‚æ•°</h2>

                <form @submit.prevent="generateScript">
                    <!-- ä¸»é¢˜æ¥æºé€‰æ‹© -->
                    <div class="form-group">
                        <label class="form-label">ä¸»é¢˜æ¥æº</label>
                        <div class="flex gap-4 mb-3">
                            <label class="flex items-center">
                                <input
                                    type="radio"
                                    x-model="topicSource"
                                    value="manual"
                                    class="mr-2"
                                >
                                <span>æ‰‹åŠ¨è¾“å…¥</span>
                            </label>
                            <label class="flex items-center">
                                <input
                                    type="radio"
                                    x-model="topicSource"
                                    value="saved"
                                    class="mr-2"
                                >
                                <span>ä»å·²ä¿å­˜ä¸»é¢˜</span>
                            </label>
                        </div>
                    </div>

                    <!-- æ‰‹åŠ¨è¾“å…¥ä¸»é¢˜ -->
                    <div x-show="topicSource === 'manual'" class="form-group">
                        <label class="form-label">ä¸»é¢˜</label>
                        <textarea
                            x-model="form.topic"
                            class="form-input"
                            rows="3"
                            placeholder="è¾“å…¥ä¸»é¢˜æè¿°ï¼Œä¾‹å¦‚ï¼šé»‘æ´æ˜¯å¦‚ä½•å½¢æˆçš„ï¼Ÿ"
                        ></textarea>
                    </div>

                    <!-- ä»å·²ä¿å­˜ä¸»é¢˜é€‰æ‹© -->
                    <div x-show="topicSource === 'saved'" class="form-group">
                        <label class="form-label">é€‰æ‹©ä¸»é¢˜</label>
                        <select x-model="form.selectedTopicId" class="form-select">
                            <option value="">-- è¯·é€‰æ‹©ä¸»é¢˜ --</option>
                            <template x-for="topic in savedTopics" :key="topic.id">
                                <option :value="topic.id" x-text="topic.title"></option>
                            </template>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            å…± <span x-text="savedTopics.length"></span> ä¸ªå·²ä¿å­˜ä¸»é¢˜
                        </p>
                    </div>

                    <!-- æ¨¡æ¿é€‰æ‹© -->
                    <div class="form-group">
                        <label class="form-label">è„šæœ¬æ¨¡æ¿</label>
                        <select x-model="form.template_name" class="form-select">
                            <option value="popular_science">ç§‘æ™®è§†é¢‘ï¼ˆæ¨èï¼‰</option>
                            <option value="experiment_demo">å®éªŒæ¼”ç¤º</option>
                            <option value="concept_explanation">æ¦‚å¿µè§£é‡Š</option>
                        </select>
                    </div>

                    <!-- è§†é¢‘æ—¶é•¿ -->
                    <div class="form-group">
                        <label class="form-label">è§†é¢‘æ—¶é•¿</label>
                        <select x-model="form.duration" class="form-select">
                            <option value="1-3min">1-3åˆ†é’Ÿï¼ˆçŸ­è§†é¢‘ï¼‰</option>
                            <option value="3-5min">3-5åˆ†é’Ÿï¼ˆæ ‡å‡†ï¼‰</option>
                            <option value="5-10min">5-10åˆ†é’Ÿï¼ˆé•¿è§†é¢‘ï¼‰</option>
                            <option value="10-15min">10-15åˆ†é’Ÿ</option>
                        </select>
                    </div>

                    <!-- ç›®æ ‡å—ä¼— -->
                    <div class="form-group">
                        <label class="form-label">ç›®æ ‡å—ä¼—</label>
                        <select x-model="form.audience" class="form-select">
                            <option value="general_public">å¤§ä¼—</option>
                            <option value="students">å­¦ç”Ÿ</option>
                            <option value="children">å„¿ç«¥</option>
                            <option value="experts">ä¸“å®¶</option>
                        </select>
                    </div>

                    <!-- è‡ªå®šä¹‰è¦æ±‚ -->
                    <div class="form-group">
                        <label class="form-label">è‡ªå®šä¹‰è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea
                            x-model="form.custom_requirements"
                            class="form-input"
                            rows="3"
                            placeholder="ä¾‹å¦‚ï¼šåŠ å…¥æ›´å¤šå®ä¾‹ã€ä½¿ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€..."
                        ></textarea>
                    </div>

                    <!-- æˆæœ¬é¢„ä¼° -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-blue-800">é¢„ä¼°APIæˆæœ¬:</span>
                            <span class="text-lg font-bold text-blue-900">$0.03-0.05</span>
                        </div>
                    </div>

                    <!-- ç”ŸæˆæŒ‰é’® -->
                    <button
                        type="submit"
                        :disabled="loading || !canGenerate"
                        class="btn btn-primary w-full"
                    >
                        <template x-if="!loading">
                            <span>ğŸš€ ç”Ÿæˆè„šæœ¬</span>
                        </template>
                        <template x-if="loading">
                            <span class="flex items-center justify-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                ç”Ÿæˆä¸­...
                            </span>
                        </template>
                    </button>
                </form>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè¿›åº¦å’Œç»“æœ -->
        <div class="lg:col-span-2">
            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div x-show="loading" class="card mb-6">
                <h3 class="text-lg font-bold mb-4">ç”Ÿæˆè¿›åº¦</h3>

                <!-- è¿›åº¦æ¡ -->
                <div class="progress-bar-container mb-4">
                    <div
                        class="progress-bar progress-bar-animated"
                        :style="`width: ${progress}%`"
                    ></div>
                </div>

                <!-- è¿›åº¦ä¿¡æ¯ -->
                <div class="flex justify-between text-sm">
                    <span x-text="progressMessage"></span>
                    <span class="font-semibold" x-text="`${progress}%`"></span>
                </div>

                <!-- é¢„è®¡æ—¶é—´ -->
                <div x-show="progress > 0 && progress < 100" class="mt-4 text-sm text-gray-600">
                    <p>â±ï¸ é¢„è®¡å‰©ä½™æ—¶é—´: <span x-text="estimatedTime"></span></p>
                </div>
            </div>

            <!-- é”™è¯¯æç¤º -->
            <div x-show="error" class="alert alert-error mb-6">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">âŒ</span>
                    <div>
                        <p class="font-bold">ç”Ÿæˆå¤±è´¥</p>
                        <p class="text-sm" x-text="error"></p>
                    </div>
                </div>
            </div>

            <!-- è„šæœ¬ç»“æœ -->
            <div x-show="script">
                <!-- è„šæœ¬ä¿¡æ¯ -->
                <div class="card mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold" x-text="script?.title || 'æœªå‘½åè„šæœ¬'"></h3>
                            <p class="text-sm text-gray-600">
                                æ—¶é•¿: <span class="font-semibold" x-text="(script?.total_duration || 0) + 'ç§’'"></span> |
                                ç« èŠ‚æ•°: <span class="font-semibold" x-text="script?.sections?.length || 0"></span>
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button
                                @click="composeVideo"
                                class="btn btn-success"
                            >
                                ğŸ¥ åˆæˆè§†é¢‘
                            </button>
                            <button
                                @click="saveScript"
                                class="btn btn-primary"
                            >
                                ğŸ’¾ ä¿å­˜
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ç« èŠ‚åˆ—è¡¨ -->
                <div class="space-y-4">
                    <template x-for="(section, index) in (script?.sections || [])" :key="index">
                        <div class="card">
                            <!-- ç« èŠ‚æ ‡é¢˜ -->
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-lg">
                                    <span class="text-purple-600">ç¬¬ <span x-text="index + 1"></span> ç« </span>
                                    <span x-text="section.section_name"></span>
                                </h4>
                                <span class="text-sm text-gray-500" x-text="section.duration + 'ç§’'"></span>
                            </div>

                            <!-- æ—ç™½ -->
                            <div class="mb-3">
                                <h5 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“ æ—ç™½</h5>
                                <p class="text-gray-800 bg-gray-50 p-3 rounded text-sm" x-text="section.narration"></p>
                            </div>

                            <!-- è§†è§‰æç¤º -->
                            <div x-show="section.visual_notes">
                                <h5 class="text-sm font-semibold text-gray-700 mb-2">ğŸ¬ è§†è§‰æç¤º</h5>
                                <p class="text-gray-600 bg-blue-50 p-3 rounded text-sm" x-text="section.visual_notes"></p>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- å…ƒæ•°æ® -->
                <div x-show="script?.metadata" class="card mt-6">
                    <h4 class="font-bold mb-3">ğŸ“‹ è„šæœ¬å…ƒæ•°æ®</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">æ¨¡æ¿:</span>
                            <span class="font-semibold" x-text="script?.metadata?.template || 'æœªçŸ¥'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">å—ä¼—:</span>
                            <span class="font-semibold" x-text="script?.metadata?.audience || 'æœªçŸ¥'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">æ—¶é•¿:</span>
                            <span class="font-semibold" x-text="script?.metadata?.duration || 'æœªçŸ¥'"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">ç”Ÿæˆæ—¶é—´:</span>
                            <span class="font-semibold" x-text="formatTime(script?.metadata?.generated_at)"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div x-show="!loading && !error && !script" class="text-center py-16">
                <div class="text-6xl mb-4">ğŸ“œ</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">å‡†å¤‡ç”Ÿæˆè„šæœ¬</h3>
                <p class="text-gray-600">é€‰æ‹©å·¦ä¾§å‚æ•°ï¼Œç‚¹å‡»"ç”Ÿæˆè„šæœ¬"å¼€å§‹</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function scriptGenerator() {
    return {
        topicSource: 'manual', // manual æˆ– saved
        savedTopics: [],
        form: {
            topic: '',
            selectedTopicId: '',
            template_name: 'popular_science',
            duration: '3-5min',
            audience: 'general_public',
            custom_requirements: ''
        },
        loading: false,
        progress: 0,
        progressMessage: '',
        startTime: null,
        script: null,
        error: '',

        get canGenerate() {
            if (this.topicSource === 'manual') {
                return this.form.topic.trim().length > 0;
            } else {
                return this.form.selectedTopicId.length > 0;
            }
        },

        get estimatedTime() {
            if (!this.startTime || this.progress === 0) return 'è®¡ç®—ä¸­...';

            const elapsed = Date.now() - this.startTime;
            const remaining = (elapsed / this.progress) * (100 - this.progress);

            const seconds = Math.floor(remaining / 1000);
            if (seconds < 60) return `${seconds}ç§’`;

            const minutes = Math.floor(seconds / 60);
            return `${minutes}åˆ†${seconds % 60}ç§’`;
        },

        async init() {
            console.log('è„šæœ¬ç”Ÿæˆé¡µé¢å·²åŠ è½½');

            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const topicId = urlParams.get('topic_id');

            if (topicId) {
                // ä»ä¸»é¢˜é¡µé¢è·³è½¬è¿‡æ¥
                this.topicSource = 'saved';
                this.form.selectedTopicId = topicId;
            }

            // åŠ è½½å·²ä¿å­˜çš„ä¸»é¢˜
            await this.loadSavedTopics();
        },

        async loadSavedTopics() {
            try {
                const response = await fetch('/api/topics/');
                const data = await response.json();

                if (data.success) {
                    this.savedTopics = data.topics || [];
                }
            } catch (error) {
                console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
            }
        },

        async generateScript() {
            this.loading = true;
            this.progress = 0;
            this.progressMessage = 'åˆ›å»ºç”Ÿæˆä»»åŠ¡...';
            this.script = null;
            this.error = '';
            this.startTime = Date.now();

            try {
                let response;

                if (this.topicSource === 'manual') {
                    // æ‰‹åŠ¨è¾“å…¥ä¸»é¢˜
                    response = await fetch('/api/scripts/generate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            topic: this.form.topic,
                            template_name: this.form.template_name,
                            duration: this.form.duration,
                            audience: this.form.audience,
                            custom_requirements: this.form.custom_requirements
                        })
                    });
                } else {
                    // ä»å·²ä¿å­˜ä¸»é¢˜ç”Ÿæˆ
                    response = await fetch('/api/scripts/generate-from-topic', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            topic_id: this.form.selectedTopicId,
                            template_name: this.form.template_name,
                            custom_requirements: this.form.custom_requirements
                        })
                    });
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                const taskId = data.task_id;

                // è¿æ¥WebSocketç›‘å¬è¿›åº¦
                await this.watchProgress(taskId);

            } catch (error) {
                console.error('ç”Ÿæˆè„šæœ¬å¤±è´¥:', error);
                this.error = error.message;
                this.loading = false;
            }
        },

        async watchProgress(taskId) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`ws://${window.location.host}/ws/progress/${taskId}`);

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    // æ›´æ–°è¿›åº¦
                    this.progress = data.progress || 0;
                    this.progressMessage = data.message || '';

                    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                    if (data.status === 'completed') {
                        this.script = data.result.script;
                        this.loading = false;
                        ws.close();
                        resolve();

                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        window.appUtils?.showToast('è„šæœ¬ç”ŸæˆæˆåŠŸï¼', 'success');

                    } else if (data.status === 'failed') {
                        this.error = data.error || 'ç”Ÿæˆå¤±è´¥';
                        this.loading = false;
                        ws.close();
                        reject(new Error(data.error));

                        window.appUtils?.showToast(this.error, 'error');
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    this.error = 'WebSocketè¿æ¥å¤±è´¥';
                    this.loading = false;
                    ws.close();
                    reject(error);
                };
            });
        },

        composeVideo() {
            // è·³è½¬åˆ°è§†é¢‘åˆæˆé¡µé¢
            window.appUtils?.showToast('å³å°†è·³è½¬åˆ°è§†é¢‘åˆæˆé¡µé¢...', 'info');
            setTimeout(() => {
                window.location.href = '/videos';
            }, 1000);
        },

        async saveScript() {
            try {
                const response = await fetch('/api/scripts/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        script: this.script
                    })
                });

                const data = await response.json();

                if (data.success) {
                    window.appUtils?.showToast('è„šæœ¬ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜è„šæœ¬å¤±è´¥:', error);
                window.appUtils?.showToast(error.message, 'error');
            }
        },

        formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN');
        }
    };
}
</script>
{% endblock %}
