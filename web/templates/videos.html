{% extends "base.html" %}

{% block title %}视频合成 - 科普视频自动化制作系统{% endblock %}

{% block content %}
<div x-data="videoComposer()" x-init="init()">
    <!-- 页面标题 -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">🎥 合成视频</h1>
        <p class="text-gray-600">从脚本自动合成带语音字幕的视频</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- 左侧：配置表单 -->
        <div class="lg:col-span-1 space-y-6">
            <!-- 步骤1: 选择脚本 -->
            <div class="card">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <span class="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center mr-2 text-sm">1</span>
                    选择脚本
                </h2>

                <div class="form-group">
                    <label class="form-label">脚本</label>
                    <select x-model="form.scriptPath" class="form-select">
                        <option value="">-- 请选择脚本 --</option>
                        <template x-for="script in scripts" :key="script.path">
                            <option :value="script.path" x-text="script.title"></option>
                        </template>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        共 <span x-text="scripts.length"></span> 个脚本
                    </p>
                </div>

                <div x-show="selectedScript" class="mt-4 p-3 bg-gray-50 rounded">
                    <p class="text-sm"><strong>标题:</strong> <span x-text="selectedScript?.title || '未知'"></span></p>
                    <p class="text-sm"><strong>时长:</strong> <span x-text="(selectedScript?.duration || 0) + '秒'"></span></p>
                    <p class="text-sm"><strong>章节数:</strong> <span x-text="selectedScript?.section_count || 0"></span></p>
                </div>
            </div>

            <!-- 步骤2: 素材配置 -->
            <div class="card">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <span class="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center mr-2 text-sm">2</span>
                    素材配置
                </h2>

                <div class="form-group">
                    <label class="flex items-center">
                        <input
                            type="checkbox"
                            x-model="form.autoSelectMaterials"
                            class="mr-2"
                        >
                        <span>自动选择素材</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">AI将根据脚本内容自动推荐素材</p>
                </div>

                <div x-show="!form.autoSelectMaterials" class="form-group">
                    <label class="form-label">手动选择素材</label>
                    <select multiple x-model="form.materialIds" class="form-select" size="4">
                        <template x-for="material in materials" :key="material.id">
                            <option :value="material.id" x-text="material.name"></option>
                        </template>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">按住Ctrl多选</p>
                </div>
            </div>

            <!-- 步骤3: 音频与字幕 -->
            <div class="card">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <span class="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center mr-2 text-sm">3</span>
                    音频与字幕
                </h2>

                <div class="form-group">
                    <label class="flex items-center">
                        <input
                            type="checkbox"
                            x-model="form.useTtsAudio"
                            class="mr-2"
                        >
                        <span>使用TTS语音</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">自动生成AI语音旁白</p>
                </div>

                <div x-show="form.useTtsAudio" class="form-group">
                    <label class="form-label">TTS声音</label>
                    <select x-model="form.ttsVoice" class="form-select">
                        <option value="alloy">Alloy (中性)</option>
                        <option value="echo">Echo (男声)</option>
                        <option value="fable">Fable (英式)</option>
                        <option value="onyx">Onyx (深沉男声)</option>
                        <option value="nova">Nova (女声)</option>
                        <option value="shimmer">Shimmer (柔和女声)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">字幕文件（可选）</label>
                    <input
                        type="text"
                        x-model="form.subtitleFile"
                        class="form-input"
                        placeholder="output/subtitles/script.srt"
                    >
                </div>
            </div>

            <!-- 步骤4: 视频参数 -->
            <div class="card">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <span class="bg-purple-600 text-white w-6 h-6 rounded-full flex items-center justify-center mr-2 text-sm">4</span>
                    视频参数
                </h2>

                <div class="form-group">
                    <label class="form-label">分辨率</label>
                    <select x-model="form.resolution" class="form-select">
                        <option value="1280x720">720p (1280x720) - 推荐</option>
                        <option value="1920x1080">1080p (1920x1080) - 高清</option>
                        <option value="854x480">480p (854x480) - 快速</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">帧率</label>
                    <select x-model="form.fps" class="form-select">
                        <option value="24">24 FPS (电影标准)</option>
                        <option value="30">30 FPS (流畅)</option>
                        <option value="60">60 FPS (超流畅)</option>
                    </select>
                </div>
            </div>

            <!-- 开始合成按钮 -->
            <button
                @click="composeVideo"
                :disabled="!canCompose || loading"
                class="btn btn-primary w-full text-lg py-3"
            >
                <template x-if="!loading">
                    <span>🎬 开始合成</span>
                </template>
                <template x-if="loading">
                    <span class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        合成中...
                    </span>
                </template>
            </button>
        </div>

        <!-- 右侧：进度和结果 -->
        <div class="lg:col-span-2">
            <!-- 进度显示 -->
            <div x-show="loading" class="card mb-6">
                <h3 class="text-lg font-bold mb-4">合成进度</h3>

                <!-- 阶段进度 -->
                <div class="space-y-4 mb-6">
                    <template x-for="(stage, index) in stages" :key="index">
                        <div class="flex items-center">
                            <div class="w-8 flex justify-center" x-text="stage.status === 'completed' ? '✅' : stage.status === 'active' ? '🔄' : '⏳'"></div>
                            <div class="flex-1">
                                <p class="font-semibold" x-text="stage.name"></p>
                                <p class="text-sm text-gray-600" x-text="stage.message"></p>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- 总进度条 -->
                <div class="progress-bar-container mb-4">
                    <div
                        class="progress-bar progress-bar-animated"
                        :style="`width: ${progress}%`"
                    ></div>
                </div>

                <!-- 进度信息 -->
                <div class="flex justify-between text-sm">
                    <span x-text="progressMessage"></span>
                    <span class="font-semibold" x-text="`${progress}%`"></span>
                </div>

                <!-- 预计时间 -->
                <div x-show="progress > 0 && progress < 100" class="mt-4 text-sm text-gray-600">
                    <p>⏱️ 预计剩余时间: <span x-text="estimatedTime"></span></p>
                </div>
            </div>

            <!-- 错误提示 -->
            <div x-show="error" class="alert alert-error mb-6">
                <div class="flex items-center">
                    <span class="text-2xl mr-3">❌</span>
                    <div>
                        <p class="font-bold">合成失败</p>
                        <p class="text-sm" x-text="error"></p>
                    </div>
                </div>
            </div>

            <!-- 合成结果 -->
            <div x-show="result">
                <div class="card mb-6">
                    <h3 class="text-xl font-bold mb-4">🎉 视频合成完成</h3>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-600">视频路径</p>
                            <p class="font-semibold" x-text="result?.video_path || '未知'"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">时长</p>
                            <p class="font-semibold" x-text="(result?.duration || 0) + '秒'"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">分辨率</p>
                            <p class="font-semibold" x-text="result?.resolution || '未知'"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">文件大小</p>
                            <p class="font-semibold" x-text="formatFileSize(result?.file_size || 0)"></p>
                        </div>
                    </div>

                    <!-- 视频预览 -->
                    <div class="mb-6" x-show="result?.video_path">
                        <h4 class="font-bold mb-3">视频预览</h4>
                        <video
                            :src="getVideoUrl(result?.video_path)"
                            controls
                            class="w-full rounded-lg"
                            style="max-height: 400px;"
                        ></video>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex gap-4" x-show="result?.video_path">
                        <a
                            :href="`/api/videos/${getVideoRelativePath(result?.video_path)}/download`"
                            download
                            class="btn btn-success flex-1"
                        >
                            📥 下载视频
                        </a>
                        <button
                            @click="reset"
                            class="btn btn-secondary"
                        >
                            🔄 合成新视频
                        </button>
                    </div>
                </div>
            </div>

            <!-- 空状态 -->
            <div x-show="!loading && !error && !result" class="text-center py-16">
                <div class="text-6xl mb-4">🎥</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">准备合成视频</h3>
                <p class="text-gray-600">选择左侧参数，点击"开始合成"</p>
            </div>

            <!-- 最近视频 -->
            <div x-show="!loading && !result" class="mt-8">
                <h3 class="text-xl font-bold mb-4">📼 最近合成的视频</h3>

                <div x-show="videos.length > 0" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="video in videos" :key="video.path">
                        <div class="card">
                            <p class="font-semibold" x-text="video?.name || '未知'"></p>
                            <p class="text-sm text-gray-600" x-text="video?.file_size_formatted || '未知大小'"></p>
                            <div class="mt-3 flex gap-2">
                                <a
                                    :href="`/api/videos/${getVideoRelativePath(video?.path)}/download`"
                                    download
                                    class="btn btn-secondary text-sm flex-1"
                                >
                                    下载
                                </a>
                                <button
                                    @click="previewVideo(video)"
                                    class="btn btn-primary text-sm"
                                >
                                    预览
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="videos.length === 0" class="text-center py-8 text-gray-500">
                    <p>暂无视频</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function videoComposer() {
    return {
        scripts: [],
        materials: [],
        videos: [],
        form: {
            scriptPath: '',
            autoSelectMaterials: true,
            materialIds: [],
            useTtsAudio: false,
            ttsVoice: 'alloy',
            subtitleFile: '',
            resolution: '1280x720',
            fps: 24
        },
        stages: [
            { name: '初始化', status: 'pending', message: '' },
            { name: '推荐素材', status: 'pending', message: '' },
            { name: '生成TTS', status: 'pending', message: '' },
            { name: '合成视频', status: 'pending', message: '' },
            { name: '完成', status: 'pending', message: '' }
        ],
        loading: false,
        progress: 0,
        progressMessage: '',
        startTime: null,
        result: null,
        error: '',

        get canCompose() {
            return this.form.scriptPath.length > 0;
        },

        get selectedScript() {
            return this.scripts.find(s => s.path === this.form.scriptPath);
        },

        get estimatedTime() {
            if (!this.startTime || this.progress === 0) return '计算中...';

            const elapsed = Date.now() - this.startTime;
            const remaining = (elapsed / this.progress) * (100 - this.progress);

            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);

            return minutes > 0 ? `${minutes}分${seconds}秒` : `${seconds}秒`;
        },

        async init() {
            console.log('视频合成页面已加载');
            await this.loadScripts();
            await this.loadVideos();
        },

        async loadScripts() {
            try {
                const response = await fetch('/api/videos/scripts/list');
                const data = await response.json();

                if (data.success) {
                    this.scripts = data.scripts || [];
                }
            } catch (error) {
                console.error('加载脚本失败:', error);
            }
        },

        async loadVideos() {
            try {
                const response = await fetch('/api/videos/');
                const data = await response.json();

                if (data.success) {
                    this.videos = data.videos || [];
                }
            } catch (error) {
                console.error('加载视频失败:', error);
            }
        },

        async composeVideo() {
            this.loading = true;
            this.progress = 0;
            this.progressMessage = '创建合成任务...';
            this.result = null;
            this.error = '';
            this.startTime = Date.now();

            // 重置阶段状态
            this.stages.forEach(s => {
                s.status = 'pending';
                s.message = '';
            });

            try {
                const response = await fetch('/api/videos/compose', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        script_path: this.form.scriptPath,
                        auto_select_materials: this.form.autoSelectMaterials,
                        material_ids: this.form.materialIds.length > 0 ? this.form.materialIds : null,
                        use_tts_audio: this.form.useTtsAudio,
                        subtitle_file: this.form.subtitleFile || null,
                        resolution: this.form.resolution,
                        fps: this.form.fps
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || data.error);
                }

                const taskId = data.task_id;

                // 连接WebSocket监听进度
                await this.watchProgress(taskId);

            } catch (error) {
                console.error('合成视频失败:', error);
                this.error = error.message;
                this.loading = false;
            }
        },

        async watchProgress(taskId) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(`ws://${window.location.host}/ws/progress/${taskId}`);

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    // 更新进度
                    this.progress = data.progress || 0;
                    this.progressMessage = data.message || '';

                    // 更新阶段状态（根据消息判断）
                    this.updateStageStatus(data.message);

                    // 检查任务状态
                    if (data.status === 'completed') {
                        this.result = data.result;
                        this.loading = false;
                        ws.close();
                        resolve();

                        // 刷新视频列表
                        this.loadVideos();

                        window.appUtils?.showToast('视频合成成功！', 'success');

                    } else if (data.status === 'failed') {
                        this.error = data.error || '合成失败';
                        this.loading = false;
                        ws.close();
                        reject(new Error(data.error));

                        window.appUtils?.showToast(this.error, 'error');
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    this.error = 'WebSocket连接失败';
                    this.loading = false;
                    ws.close();
                    reject(error);
                };
            });
        },

        updateStageStatus(message) {
            const msg = message.toLowerCase();

            if (msg.includes('init') || msg.includes('初始化')) {
                this.stages[0].status = 'active';
                this.stages[0].message = message;
            } else if (msg.includes('recommend') || msg.includes('素材')) {
                this.stages[0].status = 'completed';
                this.stages[1].status = 'active';
                this.stages[1].message = message;
            } else if (msg.includes('tts') || msg.includes('音频')) {
                this.stages[1].status = 'completed';
                this.stages[2].status = 'active';
                this.stages[2].message = message;
            } else if (msg.includes('compose') || msg.includes('合成')) {
                this.stages[2].status = 'completed';
                this.stages[3].status = 'active';
                this.stages[3].message = message;
            } else if (msg.includes('complete') || msg.includes('完成')) {
                this.stages[3].status = 'completed';
                this.stages[4].status = 'completed';
                this.stages[4].message = message;
            }
        },

        getVideoUrl(videoPath) {
            // 返回视频文件的相对路径用于播放
            if (!videoPath) return '';
            return `/output/videos/${Path(videoPath).name}`;
        },

        getVideoRelativePath(videoPath) {
            // 返回相对于output/videos的路径
            if (!videoPath) return '';
            return Path(videoPath).name;
        },

        previewVideo(video) {
            // 打开视频预览
            if (!video?.path) return;
            window.open(this.getVideoUrl(video.path), '_blank');
        },

        reset() {
            this.result = null;
            this.progress = 0;
            this.stages.forEach(s => {
                s.status = 'pending';
                s.message = '';
            });
        },

        formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    };
}
</script>
{% endblock %}
