{% extends "base.html" %}

{% block title %}é¦–é¡µ - ç§‘æ™®è§†é¢‘è‡ªåŠ¨åŒ–åˆ¶ä½œç³»ç»Ÿ{% endblock %}

{% block content %}
<div x-data="dashboard()">
    <!-- æ¬¢è¿æ¨ªå¹… -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-lg shadow-xl p-8 mb-8">
        <h1 class="text-4xl font-bold mb-2">ğŸ¬ æ¬¢è¿ä½¿ç”¨ç§‘æ™®è§†é¢‘è‡ªåŠ¨åŒ–åˆ¶ä½œç³»ç»Ÿ</h1>
        <p class="text-xl text-purple-100">AIé©±åŠ¨çš„ç«¯åˆ°ç«¯è§†é¢‘ç”Ÿäº§å¹³å°</p>
        <p class="text-sm text-purple-200 mt-4">ä»ä¸»é¢˜ç”Ÿæˆåˆ°æˆå“è§†é¢‘ï¼Œå…¨ç¨‹è‡ªåŠ¨åŒ–</p>
    </div>

    <!-- å¿«é€Ÿå¼€å§‹å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- ç”Ÿæˆä¸»é¢˜ -->
        <a href="/topics" class="group">
            <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition p-6 border-l-4 border-purple-500">
                <div class="flex items-center mb-4">
                    <div class="text-4xl mr-3">ğŸ“</div>
                    <h3 class="text-xl font-bold text-gray-800">ç”Ÿæˆä¸»é¢˜</h3>
                </div>
                <p class="text-gray-600 text-sm">AIç”Ÿæˆç§‘æ™®è§†é¢‘ä¸»é¢˜å»ºè®®</p>
                <div class="mt-4 text-purple-600 text-sm font-semibold group-hover:text-purple-800">
                    å¼€å§‹ä½¿ç”¨ â†’
                </div>
            </div>
        </a>

        <!-- ç”Ÿæˆè„šæœ¬ -->
        <a href="/scripts" class="group">
            <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition p-6 border-l-4 border-blue-500">
                <div class="flex items-center mb-4">
                    <div class="text-4xl mr-3">ğŸ“œ</div>
                    <h3 class="text-xl font-bold text-gray-800">ç”Ÿæˆè„šæœ¬</h3>
                </div>
                <p class="text-gray-600 text-sm">ä»ä¸»é¢˜è‡ªåŠ¨ç”Ÿæˆè§†é¢‘è„šæœ¬</p>
                <div class="mt-4 text-blue-600 text-sm font-semibold group-hover:text-blue-800">
                    å¼€å§‹ä½¿ç”¨ â†’
                </div>
            </div>
        </a>

        <!-- åˆæˆè§†é¢‘ -->
        <a href="/videos" class="group">
            <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition p-6 border-l-4 border-green-500">
                <div class="flex items-center mb-4">
                    <div class="text-4xl mr-3">ğŸ¥</div>
                    <h3 class="text-xl font-bold text-gray-800">åˆæˆè§†é¢‘</h3>
                </div>
                <p class="text-gray-600 text-sm">ä¸€é”®ç”Ÿæˆå¸¦è¯­éŸ³å­—å¹•çš„è§†é¢‘</p>
                <div class="mt-4 text-green-600 text-sm font-semibold group-hover:text-green-800">
                    å¼€å§‹ä½¿ç”¨ â†’
                </div>
            </div>
        </a>

        <!-- ç´ æç®¡ç† -->
        <a href="/materials" class="group">
            <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition p-6 border-l-4 border-orange-500">
                <div class="flex items-center mb-4">
                    <div class="text-4xl mr-3">ğŸ¨</div>
                    <h3 class="text-xl font-bold text-gray-800">ç´ æç®¡ç†</h3>
                </div>
                <p class="text-gray-600 text-sm">æµè§ˆå’Œç®¡ç†ç´ æåº“</p>
                <div class="mt-4 text-orange-600 text-sm font-semibold group-hover:text-orange-800">
                    å¼€å§‹ä½¿ç”¨ â†’
                </div>
            </div>
        </a>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">ä¸»é¢˜æ€»æ•°</p>
                    <p class="text-3xl font-bold text-purple-600" x-text="stats.topics">-</p>
                </div>
                <div class="text-5xl opacity-20">ğŸ“</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">è„šæœ¬æ€»æ•°</p>
                    <p class="text-3xl font-bold text-blue-600" x-text="stats.scripts">-</p>
                </div>
                <div class="text-5xl opacity-20">ğŸ“œ</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm">è§†é¢‘æ€»æ•°</p>
                    <p class="text-3xl font-bold text-green-600" x-text="stats.videos">-</p>
                </div>
                <div class="text-5xl opacity-20">ğŸ¥</div>
            </div>
        </div>
    </div>

    <!-- æœ€è¿‘ä»»åŠ¡ -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-4">ğŸ“‹ æœ€è¿‘ä»»åŠ¡</h2>

        <div x-show="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
            <p class="text-gray-600 mt-4">åŠ è½½ä¸­...</p>
        </div>

        <div x-show="!loading && recentTasks.length === 0" class="text-center py-8 text-gray-500">
            <p>æš‚æ— ä»»åŠ¡è®°å½•</p>
            <p class="text-sm mt-2">å¼€å§‹åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªè§†é¢‘å§ï¼</p>
        </div>

        <div x-show="!loading && recentTasks.length > 0" class="space-y-3">
            <template x-for="task in recentTasks" :key="task.id">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl">
                            <span x-show="task.type === 'generate_topics'">ğŸ“</span>
                            <span x-show="task.type === 'generate_script'">ğŸ“œ</span>
                            <span x-show="task.type === 'compose_video'">ğŸ¥</span>
                            <span x-show="task.type === 'generate_tts'">ğŸ”Š</span>
                        </div>
                        <div>
                            <p class="font-semibold" x-text="task.message"></p>
                            <p class="text-sm text-gray-500" x-text="formatTime(task.created_at)"></p>
                        </div>
                    </div>
                    <div>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold"
                              :class="{
                                  'bg-green-100 text-green-800': task.status === 'completed',
                                  'bg-yellow-100 text-yellow-800': task.status === 'running',
                                  'bg-red-100 text-red-800': task.status === 'failed',
                                  'bg-gray-100 text-gray-800': task.status === 'pending'
                              }" x-text="statusText(task.status)"></span>
                    </div>
                </div>
            </template>
        </div>

        <div class="mt-4 text-center">
            <a href="/history" class="text-purple-600 hover:text-purple-800 font-semibold">
                æŸ¥çœ‹æ‰€æœ‰å†å² â†’
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboard() {
    return {
        stats: {
            topics: 0,
            scripts: 0,
            videos: 0
        },
        recentTasks: [],
        loading: true,

        async init() {
            // åŠ è½½ç»Ÿè®¡æ•°æ®
            await this.loadStats();
            // åŠ è½½æœ€è¿‘ä»»åŠ¡
            await this.loadRecentTasks();
            this.loading = false;
        },

        async loadStats() {
            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰ç»Ÿè®¡
                const [topicsRes, scriptsRes, videosRes] = await Promise.all([
                    fetch('/api/topics/stats/summary'),
                    fetch('/api/scripts/stats/summary'),
                    fetch('/api/videos/stats/summary')
                ]);

                const topicsData = await topicsRes.json();
                const scriptsData = await scriptsRes.json();
                const videosData = await videosRes.json();

                if (topicsData.success) {
                    this.stats.topics = topicsData.stats.total_topics || 0;
                }
                if (scriptsData.success) {
                    this.stats.scripts = scriptsData.stats.total_scripts || 0;
                }
                if (videosData.success) {
                    this.stats.videos = videosData.stats.total_videos || 0;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        },

        async loadRecentTasks() {
            try {
                const response = await fetch('/api/history/recent?limit=5');
                const data = await response.json();

                if (data.success) {
                    this.recentTasks = data.tasks || [];
                }
            } catch (error) {
                console.error('åŠ è½½æœ€è¿‘ä»»åŠ¡å¤±è´¥:', error);
            }
        },

        formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN');
        },

        statusText(status) {
            const statusMap = {
                'completed': 'å·²å®Œæˆ',
                'running': 'è¿›è¡Œä¸­',
                'failed': 'å¤±è´¥',
                'pending': 'ç­‰å¾…ä¸­'
            };
            return statusMap[status] || status;
        }
    };
}
</script>
{% endblock %}
